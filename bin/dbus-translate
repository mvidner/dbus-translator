#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift File.expand_path("../lib", __dir__)

require "dbus-babel"

tools = []
execute = false
while ARGV.first.to_s.start_with? "-"
  case ARGV.first
  when "-x", "--execute"
    execute = true
  when "-d"
    tools << DBusBabel::DBusSend
  when "-b"
    tools << DBusBabel::Busctl
  when "-g"
    tools << DBusBabel::GDBus
  else
    warn "Unrecognized option #{ARGV.first.inspect}"
  end
  ARGV.shift
end

tools = [DBusBabel::DBusSend, DBusBabel::Busctl, DBusBabel::GDBus] if tools.empty?

command = DBusBabel.parse_argv(ARGV)

if command.nil?
  warn "Unrecognized tool #{ARGV.first.inspect}"
  exit 1
end

tools.each do |klass|
  shell_command = klass.new(command).to_s
  puts shell_command
  system shell_command if execute
end
